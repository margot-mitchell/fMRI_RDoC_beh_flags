# Automated Weekly Processing Setup

This document explains how to configure the automated weekly fMRI behavioral QC processing workflow that runs every Sunday at 5:00 PM UTC.

## Overview

The automated workflow (`weekly_automated_processing.yml`) performs the following tasks:

1. **Detects new data**: Scans the Dropbox `/output/raw` folder for data modified in the past week
2. **Processes new data**: Runs the full pipeline (preprocessing, metrics calculation, flagging) on new subjects/sessions
3. **Compiles results**: Creates a summary report and compiles all artifacts
4. **Sends email notifications**: Automatically emails results to specified recipients

## Required GitHub Secrets

You need to configure the following secrets in your GitHub repository:

### 1. RCLONE_CONFIG (Already configured)
- Base64-encoded rclone configuration for Dropbox access
- Should already be set up from your manual workflow

### 2. Email Configuration Secrets

Add these secrets in your GitHub repository settings:

#### GMAIL_USERNAME
- Your Gmail address (e.g., `your-email@gmail.com`)

#### GMAIL_PASSWORD
- Your Gmail app password (recommended) or regular password
- **Note**: For better security, use an "App Password" (see GMAIL_SMTP_SETUP.md for detailed instructions)

#### EMAIL_RECIPIENTS
- Comma-separated list of email addresses to receive notifications
- Example: `researcher1@university.edu,researcher2@university.edu`

## Setting Up Email Notifications

### For Gmail (Recommended):
1. Enable 2-factor authentication on your Google account
2. Generate an "App Password":
   - Go to Google Account settings
   - Security → 2-Step Verification → App passwords
   - Generate a password for "Mail"
3. Use the generated password as `GMAIL_PASSWORD`
4. Set `GMAIL_USERNAME` to your Gmail address

**For detailed Gmail setup instructions, see `GMAIL_SMTP_SETUP.md`**

## Workflow Schedule

The workflow runs automatically:
- **When**: Every Sunday at 5:00 PM UTC
- **What**: Scans for data modified in the past 7 days
- **Manual trigger**: Can also be run manually via GitHub Actions

## What the Workflow Does

### 1. Data Detection
- Syncs with Dropbox to check for new data
- Identifies subjects and sessions with files modified in the past week
- **Excludes prescan sessions** (sessions containing "prescan" in the name)
- Only processes data that has actually changed

### 2. Processing
- Runs the complete pipeline on each new subject/session
- Preprocessing → Metrics calculation → Flagging
- Tests metrics completeness
- Organizes results into artifacts with flatter structure

### 3. Results Compilation
- Downloads all artifacts from parallel processing
- Creates a summary report with:
  - List of processed subjects
  - Total number of artifacts
  - Count of quality flags found
- Uploads compiled results as a single artifact

### 4. Email Notification
- Sends a summary email to all recipients
- Includes:
  - Processing period and workflow run ID
  - Summary of processed subjects and sessions
  - Quality flag breakdown by subject-session
  - Links to GitHub Actions run and artifacts

## Email Content

The automated email includes:
- Processing period (date range)
- Workflow run ID
- Clean list of processed subjects and sessions (no JSON formatting)
- Quality flag breakdown with each subject-session on its own line
- Links to detailed results in GitHub Actions
- Repository information

## Monitoring and Troubleshooting

### Check Workflow Status
1. Go to your GitHub repository
2. Click "Actions" tab
3. Look for "Weekly Automated Data Processing" workflow
4. Check run history and logs

### Common Issues

#### No new data detected
- The workflow will skip processing if no data was modified in the past week
- Check the "detect-new-data" job logs to see what was scanned

#### Email delivery issues
- Verify Gmail credentials are correct
- Check if you need to use an app password (see GMAIL_SMTP_SETUP.md)
- Test with a simple email first

#### Processing failures
- Check individual job logs for specific errors
- Common issues: missing dependencies, data format problems, network issues

## Customization

### Change Schedule
Edit the cron expression in the workflow:
```yaml
schedule:
  - cron: '0 17 * * 0'  # Sunday 5:00 PM UTC
```

### Modify Email Content
The email content is generated by `generate_email_body.sh` script. Edit this script to customize the email message.

### Add More Recipients
Update the `EMAIL_RECIPIENTS` secret with additional email addresses (comma-separated).

## Security Notes

- All secrets are encrypted and only accessible to repository administrators
- Email credentials are stored securely in GitHub Secrets
- Use app-specific passwords for Gmail accounts when possible
- Regularly rotate email passwords for security

## Testing

Before relying on the automated workflow:
1. Test the manual workflow to ensure it works correctly
2. Test email notifications with a small dataset
3. Verify all secrets are configured correctly
4. Check that the schedule works for your timezone (UTC conversion)

## Artifact Structure

The workflow creates artifacts with a clean, flat structure:
```
sub-s4-ses-3_results/
├── metrics/
├── flags/
└── preprocessed_data/
```

This makes it easy to download and navigate the results. 